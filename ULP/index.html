<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation (Wiki) for Tasmota"><link href=https://tasmota.github.io/docs/ULP/ rel=canonical><link rel=icon href=../_media/favicon.ico><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.12"><title>ULP for ESP32 :material-cpu-32-bit: - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Barlow";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8J08F8X90S"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8J08F8X90S",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8J08F8X90S",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#ulp-for-esp32 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title=Tasmota class="md-header__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tasmota </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ULP for ESP32 :material-cpu-32-bit: </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../Features/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../ESP32/ class=md-tabs__link> ESP32 </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> <li class=md-tabs__item> <a href=http://tasmota.github.io/install class=md-tabs__link> Web Installer </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> News </a> </li> <li class=md-nav__item> <a href=../About/ class=md-nav__link> About </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../Upgrading/ class=md-nav__link> Upgrading </a> </li> <li class=md-nav__item> <a href=../MQTT/ class=md-nav__link> MQTT </a> </li> <li class=md-nav__item> <a href=../Commands/ class=md-nav__link> Commands </a> </li> <li class=md-nav__item> <a href=../Templates/ class=md-nav__link> Templates </a> </li> <li class=md-nav__item> <a href=../Components/ class=md-nav__link> Components </a> </li> <li class=md-nav__item> <a href=../Modules/ class=md-nav__link> Modules </a> </li> <li class=md-nav__item> <a href=../Peripherals/ class=md-nav__link> Peripherals </a> </li> <li class=md-nav__item> <a href=../WebUI/ class=md-nav__link> WebUI </a> </li> <li class=md-nav__item> <a href=../Firmware-Builds/ class=md-nav__link> Firmware Builds </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ class=md-nav__link> Compiling </a> </li> <li class=md-nav__item> <a href=../Contributing/ class=md-nav__link> Contributing </a> </li> <li class=md-nav__item> <a href=../Download/ class=md-nav__link> Download </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/discussions/categories/show-and-tell class=md-nav__link> Project Showcase </a> </li> <li class=md-nav__item> <a href=../For-Developers/ class=md-nav__link> For Developers </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Features <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Features/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../ADC/ class=md-nav__link> Analog Pin </a> </li> <li class=md-nav__item> <a href=../ArtNet/ class=md-nav__link> ArtNet DMX </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ class=md-nav__link> Buttons and Switches </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ class=md-nav__link> DeepSleep </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ class=md-nav__link> Device Groups </a> </li> <li class=md-nav__item> <a href=../Displays/ class=md-nav__link> Displays </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ class=md-nav__link> Dynamic Sleep </a> </li> <li class=md-nav__item> <a href=../I2CDEVICES/ class=md-nav__link> I2C Devices </a> </li> <li class=md-nav__item> <a href=../IPv6/ class=md-nav__link> IPv6 </a> </li> <li class=md-nav__item> <a href=../Lights/ class=md-nav__link> Lights </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ class=md-nav__link> PIR Motion Sensors </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ class=md-nav__link> Power Monitoring Calibration </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ class=md-nav__link> PWM Dimmer </a> </li> <li class=md-nav__item> <a href=../Rules/ class=md-nav__link> Rules </a> </li> <li class=md-nav__item> <a href=../Scripting-Language/ class=md-nav__link> Scripting Language </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ class=md-nav__link> Shutters and Blinds </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_18> <label class=md-nav__link for=__nav_2_18 id=__nav_2_18_label tabindex=0> Protocol Bridging <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_18_label aria-expanded=false> <label class=md-nav__title for=__nav_2_18> <span class="md-nav__icon md-icon"></span> Protocol Bridging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../TasmotaClient/ class=md-nav__link> Arduino MCU </a> </li> <li class=md-nav__item> <a href=../Bluetooth/ class=md-nav__link> BLE Gateway </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ class=md-nav__link> IR Communication </a> </li> <li class=md-nav__item> <a href=../Projector/ class=md-nav__link> LCD/DLP Projector Control </a> </li> <li class=md-nav__item> <a href=../Modbus-Bridge/ class=md-nav__link> Modbus Bridge </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> OpenTherm </a> </li> <li class=md-nav__item> <a href=../RF-Protocol/ class=md-nav__link> RF Communication </a> </li> <li class=md-nav__item> <a href=../Serial-to-TCP-Bridge/ class=md-nav__link> Serial to TCP Bridge </a> </li> <li class=md-nav__item> <a href=../Zigbee/ class=md-nav__link> Zigbee </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ class=md-nav__link> Smart Meter Interface </a> </li> <li class=md-nav__item> <a href=../Thermostat/ class=md-nav__link> Thermostat </a> </li> <li class=md-nav__item> <a href=../Timers/ class=md-nav__link> Timers </a> </li> <li class=md-nav__item> <a href=../TLS/ class=md-nav__link> TLS Secured MQTT </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ class=md-nav__link> TuyaMCU </a> </li> <li class=md-nav__item> <a href=../UFS/ class=md-nav__link> Universal File System </a> </li> <li class=md-nav__item> <a href=../Range-Extender/ class=md-nav__link> Wi-Fi Range Extender </a> </li> <li class=md-nav__item> <a href=../Tutorials/ class=md-nav__link> Projects and Tutorials </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> ESP32 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> ESP32 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ESP32/ class=md-nav__link> Tasmota32 Features </a> </li> <li class=md-nav__item> <a href=../Berry/ class=md-nav__link> Berry </a> </li> <li class=md-nav__item> <a href=../Bluetooth_ESP32/ class=md-nav__link> Bluetooth Low Energy </a> </li> <li class=md-nav__item> <a href=../I2S-Audio/ class=md-nav__link> I2S Audio </a> </li> <li class=md-nav__item> <a href=../LVGL/ class=md-nav__link> LVGL </a> </li> <li class=md-nav__item> <a href=../HASPmota/ class=md-nav__link> HASPmota </a> </li> <li class=md-nav__item> <a href=../Tasmota-Application/ class=md-nav__link> Tasmota Application Files </a> </li> <li class=md-nav__item> <a href=../TouchPin/ class=md-nav__link> Touch GPIOs </a> </li> <li class=md-nav__item> <a href=../Safeboot/ class=md-nav__link> Safeboot Partition Layout </a> </li> <li class=md-nav__item> <a href=https://templates.blakadder.com/esp32 class=md-nav__link> Supported Devices </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> Smart Home Integrations <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../Alexa/ class=md-nav__link> Alexa </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ class=md-nav__link> AWS IoT </a> </li> <li class=md-nav__item> <a href=../Domoticz/ class=md-nav__link> Domoticz </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ class=md-nav__link> Home Assistant </a> </li> <li class=md-nav__item> <a href=../Homebridge/ class=md-nav__link> Homebridge </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ class=md-nav__link> HomeSeer </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ class=md-nav__link> IP Symcon </a> </li> <li class=md-nav__item> <a href=../KNX/ class=md-nav__link> KNX </a> </li> <li class=md-nav__item> <a href=../NodeRed/ class=md-nav__link> NodeRed </a> </li> <li class=md-nav__item> <a href=../nymea/ class=md-nav__link> nymea </a> </li> <li class=md-nav__item> <a href=../Octoprint/ class=md-nav__link> OctoPrint </a> </li> <li class=md-nav__item> <a href=../openHAB/ class=md-nav__link> openHAB </a> </li> <li class=md-nav__item> <a href=../otto/ class=md-nav__link> Otto </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 class=md-nav__link> IOBroker </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter class=md-nav__link> Mozilla WebThings Adapter </a> </li> <li class=md-nav__item> <a href=https://github.com/hongtat/tasmota-connect class=md-nav__link> SmartThings </a> </li> <li class=md-nav__item> <a href=https://github.com/Gifford47/tasmohab/blob/master/README.md class=md-nav__link> Tasmohab </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Supported-Peripherals/ class=md-nav__link> Peripherals </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> Supported Devices <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-nav__link> Configure Unknown Device </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' class=md-nav__link> All Supported Devices </a> </li> <li class=md-nav__item> <a href=../Pinouts/ class=md-nav__link> Wi-Fi Module Pinouts </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ class=md-nav__link> Supported Modules </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> Help <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ class=md-nav__link> Device Recovery </a> </li> <li class=md-nav__item> <a href="https://discord.gg/Ks2Kzd4 " target='_blank""' class=md-nav__link> Discord Support </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=http://tasmota.github.io/install class=md-nav__link> Web Installer </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#ultra-low-power-coprocessor class=md-nav__link> Ultra Low Power coprocessor </a> <nav class=md-nav aria-label="Ultra Low Power coprocessor"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fsm-and-riscv-what class=md-nav__link> FSM and RISCV ... what? </a> </li> <li class=md-nav__item> <a href=#limits-of-the-ulp class=md-nav__link> Limits of the ULP </a> </li> <li class=md-nav__item> <a href=#advantages-of-the-ulp class=md-nav__link> Advantages of the ULP </a> </li> <li class=md-nav__item> <a href=#data-exchange-between-main-system-and-ulp class=md-nav__link> Data exchange between main system and ULP </a> </li> <li class=md-nav__item> <a href=#general-program-flow class=md-nav__link> General program flow </a> </li> <li class=md-nav__item> <a href=#tasmota-conventions class=md-nav__link> Tasmota conventions </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#using-external-toolchains-for-this-driver class=md-nav__link> Using external toolchains for this driver </a> <nav class=md-nav aria-label="Using external toolchains for this driver"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#micropython-and-micropython-esp32-ulp-fsm-only class=md-nav__link> Micropython and micropython-esp32-ulp (FSM only) </a> </li> <li class=md-nav__item> <a href=#export-from-esp-idf-project class=md-nav__link> Export from ESP-IDF project </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#examples class=md-nav__link> Examples </a> <nav class=md-nav aria-label=Examples> <ul class=md-nav__list> <li class=md-nav__item> <a href=#blink-an-led-fsm class=md-nav__link> Blink an LED - FSM </a> </li> <li class=md-nav__item> <a href=#hall-sensor-fsm class=md-nav__link> Hall sensor - FSM </a> </li> <li class=md-nav__item> <a href=#i2c-access-fsm class=md-nav__link> I2C access - FSM </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/ULP.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg> </a> <h1 id=ulp-for-esp32>ULP for ESP32 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v2H7a2 2 0 0 0-2 2v2H3v2h2v2H3v2h2v2a2 2 0 0 0 2 2h2v2h2v-2h2v2h2v-2h2a2 2 0 0 0 2-2v-2h2v-2h-2v-2h2V9h-2V7a2 2 0 0 0-2-2h-2V3h-2v2h-2V3M7 9h3.5a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H7v-1.5h3v-.75H8.5v-1.5H10v-.75H7M12.5 9H16a1 1 0 0 1 1 1v1.75a1 1 0 0 1-1 1h-2v.75h3V15h-4.5v-2.75a1 1 0 0 1 1-1h2v-.75h-3"/></svg></span><a class=headerlink href=#ulp-for-esp32 title="Permanent link">~</a></h1> <details class=failure> <summary>This feature is not included in precompiled binaries</summary> <p>When <a href=../Compile-your-build/ >compiling your build</a> add the following to <code>user_config_override.h</code>: <div class=highlight><pre><span></span><code><span class=cp>#define USE_BERRY_ULP      </span><span class=c1>// (ESP32, ESP32S2 and ESP32S3 only) Add support for the ULP via Berry (+5k flash)</span>
</code></pre></div> or add as a build flag to any build environment, i.e. in platformio_tasmota_cenv.ini:<br> <div class=highlight><pre><span></span><code>build_flags             = ${env:tasmota32_base.build_flags}
                        -DUSE_BERRY_ULP
</code></pre></div></p> </details> <h2 id=ultra-low-power-coprocessor>Ultra Low Power coprocessor<a class=headerlink href=#ultra-low-power-coprocessor title="Permanent link">~</a></h2> <p>The purpose of this document is not to repeat every information of these documents:<br> <a href=https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ulp.html>https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ulp.html</a><br> <a href=https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ulp_instruction_set.html>https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ulp_instruction_set.html</a> </p> <p>It will also not make it easy to write assembler code for the ULP and embed it in Berry projects. But it shall guide you through the process of adapting one of many open source examples, do some little changes and setting up a toolchain for personal use cases. </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>It can even make it easier and substantially faster to rapidly develop assembler projects, because there is no flashing involved in the code deployment, which happens in Berry at runtime.</p> </div> <h3 id=fsm-and-riscv-what>FSM and RISCV ... what?<a class=headerlink href=#fsm-and-riscv-what title="Permanent link">~</a></h3> <p>Currently there are 3 SOC's of the ESP32-family with an included ULP, which are the ESP32, the ESP32S2 and the ESP32S3.<br> The oldest one - the ESP32 - features the simplest type, which Espressif names <strong>Finite State Machine</strong> or in short <strong>FSM</strong>. This ULP can only be programmed in assembly.<br> The newer ESP32S2/S3 allow to run the ULP in FSM mode too with some minor additions in the instruction set. They are able ( = should be able in most cases) to use the same assembly source code, but the resulting binaries are not compatible.<br> But additionally both of the new models (ESPS2/S3) are able to run the ULP in RISCV mode, which has a different toolchain and allows to use C as programming language. This makes it a lot easier to work with it. Only one ULP mode possible at a time, so you can run only in FSM or RISCV mode.<br> For Tasmota it was decided to keep things as simple and modern as possible, thus for ESP32S2 and ESP32S3 the old FSM mode is not supported and we enjoy the simplicity of the high level language C. </p> <p>Bottom line for Tasmota:<br> <strong>ESP32</strong> - uses ULP in <strong>FSM</strong> mode<br> <strong>ESP32S2 and ESP32S3</strong> - use ULP in <strong>RISCV</strong> mode </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Although the main core of the ESP32C3 uses the RISCV architecure, there is no built in ULP at all. For the upcoming ESP32C6 an integrated ULP was anounced, but no further info is available at the moment. </p> </div> <h3 id=limits-of-the-ulp>Limits of the ULP<a class=headerlink href=#limits-of-the-ulp title="Permanent link">~</a></h3> <p>To simplify some things:<br> Everything in the ULP is limited. On the old FSM type ULP there are only 4 registers, very few operations and limited memory access. For some operations it is not possible to use mutable values, but the code must be fixed (for pin/register access) at compile time. That's why you will see lots of defines and constants in basically every example project.<br> This was the reason, why for projects like Tasmota it never made sense to include ULP code. </p> <h3 id=advantages-of-the-ulp>Advantages of the ULP<a class=headerlink href=#advantages-of-the-ulp title="Permanent link">~</a></h3> <p>Besides the possibility to run code in deep sleep and wake up the system, it can also make sense to run the ULP in parallel to the main system.<br> To simplify again:<br> Everything that is critical to precise timing and is somehow portable to ULP, should run better than on the main cores! This includes the internal temperature sensor and the hall sensor. Additionally it can free the main cores of some tasks. </p> <h3 id=data-exchange-between-main-system-and-ulp>Data exchange between main system and ULP<a class=headerlink href=#data-exchange-between-main-system-and-ulp title="Permanent link">~</a></h3> <p>There is a memory region which is located at fixed address 0x5000000, which is called RTC_SLOW_MEM. This is the only region that is accessible from main cores and the ULP. It is the coders job to find a way to control the data flow, by reading and writing from and to certain addresses. The toolchains down below will print out data, that will show, where accessible variable can be found to access from Berry with <code>ULP.get_mem()</code> and <code>ULP.set_mem()</code>. </p> <h3 id=general-program-flow>General program flow<a class=headerlink href=#general-program-flow title="Permanent link">~</a></h3> <p>A typical ULP program is started from the main core at the position of the so called <em>global entry point</em>. Then it executes its chain of commands and ends with a <code>halt</code> command. It is technically possible to create a run loop inside the code and to not end with <code>halt</code>. But typically such a loop is realized with a wakeup timer, that restarts the with a certain interval, which can be set with <code>ULP.wake_period(register,time in microseconds)</code>. The register is numbered from 0 to 4 and can be changed in the assembly code with <code>sleep register</code>. </p> <h3 id=tasmota-conventions>Tasmota conventions<a class=headerlink href=#tasmota-conventions title="Permanent link">~</a></h3> <p>The assembly code can be divided in different sections of which the so called <code>.text</code>sections contains the program, but can hold variables or arbitrary data too. In general for the assembler it is not so important, where the functions or the <em>global entry point</em> is located.<br> But for the FSM in Tasmota the rule is, that the global entry point or a jump to it is located at position 0 in RTC_SLOW_MEM. That way <code>ULP.run()</code> can always point to this address 0. On RISCV ULP's the entry point is always 0.<br> It is a design decision to keep the ULP module as small as possible and the addition of more internal functions shall be avoided, i.e. for doing setup of GPIO/RTC pins. If possible, this should be done in assembly code. </p> <div class="admonition example"> <p class=admonition-title>Example</p> </div> <div class=highlight><pre><span></span><code><span class=c1>// rtc_gpio_isolate(12) translates to:</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_IO_TOUCH_PAD5_REG</span><span class=p>,</span><span class=w> </span><span class=mi>27</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>//disable pullup</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_IO_TOUCH_PAD5_REG</span><span class=p>,</span><span class=w> </span><span class=mi>28</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>//disable pulldown</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_IO_TOUCH_PAD5_REG</span><span class=p>,</span><span class=w> </span><span class=mi>13</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>//disable input</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_GPIO_ENABLE_W1TS_REG</span><span class=p>,</span><span class=w> </span><span class=mi>29</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>//disable output</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_IO_TOUCH_PAD5_REG</span><span class=p>,</span><span class=w> </span><span class=mi>31</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=c1>//hold</span>
</code></pre></div> <h2 id=using-external-toolchains-for-this-driver>Using external toolchains for this driver<a class=headerlink href=#using-external-toolchains-for-this-driver title="Permanent link">~</a></h2> <p>There are 2 ways to assemble code for later use in Tasmota. In theory every external ULP project, which fits in the reserved memory space that is defined in the framework package used to compile the Tasmota firmware, should be convertible. This limit is subject to change. </p> <h3 id=micropython-and-micropython-esp32-ulp-fsm-only>Micropython and micropython-esp32-ulp (FSM only)<a class=headerlink href=#micropython-and-micropython-esp32-ulp-fsm-only title="Permanent link">~</a></h3> <p>Only available for the ESP32 using the FSM type ULP.</p> <p>A great project to run ULP code in Micropython on the ESP32 can be used to assemble and export the same projects to Tasmota.<br> There are ports of Micropython for Linux, Windows and Mac, which must be installed to the system of your choice. Run it and in the Micropython console install like that:<br> <div class=highlight><pre><span></span><code><span class=c1># MacOS</span>
<span class=kn>import</span> <span class=nn>upip</span>
<span class=c1># Linux</span>
<span class=kn>import</span> <span class=nn>mip</span>
<span class=n>upip</span><span class=o>.</span><span class=n>install</span><span class=p>(</span><span class=s1>&#39;micropython-esp32-ulp&#39;</span><span class=p>)</span>
</code></pre></div></p> <p>After that your are ready to assemble.<br> The ULP code is embedded as a multiline string in Micropython scripts. For use in Tasmota it makes sense to make some changes, that are described in an <a href=https://github.com/Staars/berry-examples/blob/main/ulp_helper/ulp_template.py>ulp_template.py</a> and to use this template by replacing the source code string with the new code. </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>The Micropython module can not really include external headers, but it offers a very convenient database function as described here: <a href=https://github.com/micropython/micropython-esp32-ulp/blob/master/docs/preprocess.rst>link:preprocess</a><br> Otherwise the missing defines must be added annually.</p> </div> <p>After you created or did download your <code>ulp_app.py</code> you can export the data with 'micropython ulp_app.py' to the console, from where it can be copy pasted to the Berry console or to your Berry project. </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>It is recommended to embed the setup steps for GPIO pins or ADC to the bottom part of this <code>ulp_app.py</code> by printing Berry commands for easier testing in the Berry console.</p> </div> <h3 id=export-from-esp-idf-project>Export from ESP-IDF project<a class=headerlink href=#export-from-esp-idf-project title="Permanent link">~</a></h3> <p>This is the only way, that works for every ULP version in Tasmota.</p> <p>Many projects are using the ESP-IDF with CMAKE and will be compiled with <code>idf.py build</code>. We can extract the ULP code without flashing this project, with two simple methods: </p> <h4 id=python-script-bins2berrypy>Python script 'binS2Berry.py'<a class=headerlink href=#python-script-bins2berrypy title="Permanent link">~</a></h4> <p>Start a helper Python <a href=https://github.com/Staars/berry-examples/blob/main/ulp_helper/binS2Berry.py>binS2Berry.py</a> script in the root level of the project, which prints the same information to console as the Micropython way. </p> <h4 id=web-app>Web-App:<a class=headerlink href=#web-app title="Permanent link">~</a></h4> <p>Use the embedded JS application right here. </p> <script src=../extra_javascript/ulp2berry.js></script> <p>ESP-IDF build folder: <input type=file id=ulp_files onchange=processULPFiles() webkitdirectory mozdirectory multiple></p> <p>(You can drag and drop the folder on the button too.)</p> <div id=ulp_output></div> <div class=highlight><pre><span></span><code><span class=c1># Generate ULP code in your browser !! Parsing completely in JS, no file upload to a server.</span>
</code></pre></div> <p>Thus the ULP projects that may fail to assemble in Micropython can be used too. Additionally it can be helpful, to test the ULP code in a minimal working example outside of Tasmota.</p> <h2 id=examples>Examples<a class=headerlink href=#examples title="Permanent link">~</a></h2> <p>This is all about porting and adapting existing code. Thank you to everyone who is sharing their ULP code!! </p> <h3 id=blink-an-led-fsm>Blink an LED - FSM<a class=headerlink href=#blink-an-led-fsm title="Permanent link">~</a></h3> <p>Let's take a look at <a href=https://github.com/micropython/micropython-esp32-ulp/blob/master/examples/blink.py>https://github.com/micropython/micropython-esp32-ulp/blob/master/examples/blink.py</a>. </p> <ol> <li>Use a copy of <a href=https://github.com/Staars/berry-examples/blob/main/ulp_helper/ulp_template.py>ulp_template.py</a> and name it to your liking.</li> <li>Replace the <code>source</code> string of the template with the version of the example. The <code>.text</code>section starts with: <div class=highlight><pre><span></span><code><span class=na>.text</span>
<span class=nl>magic:</span><span class=w> </span><span class=na>.long</span><span class=w> </span><span class=mi>0</span>
<span class=nl>state:</span><span class=w> </span><span class=na>.long</span><span class=w> </span><span class=mi>0</span>
</code></pre></div> this must become: <div class=highlight><pre><span></span><code><span class=na>.text</span>
<span class=nf>jump</span><span class=w> </span><span class=no>entry</span>
<span class=nl>magic:</span><span class=w> </span><span class=na>.long</span><span class=w> </span><span class=mi>0</span>
<span class=nl>state:</span><span class=w> </span><span class=na>.long</span><span class=w> </span><span class=mi>0</span>
</code></pre></div></li> <li>This is already enough to assemble. For convenience it is recommended to add a line to the last section (with multiple "prints") with content: <code>print("ULP.wake_period(0, 500000)")</code>. </li> </ol> <p>Done!</p> <p>Now let's modify the code slightly for different intervals for "on" and "off".</p> <ol> <li>Add a second wake period with <code>print("ULP.wake_period(1, 200000)")</code>.</li> <li>Add <code>sleep</code> commands to the source code like so: <div class=highlight><pre><span></span><code><span class=nl>on:</span>
<span class=c1># turn on led (set GPIO)</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_GPIO_ENABLE_W1TS_REG</span><span class=p>,</span><span class=w> </span><span class=no>RTC_GPIO_ENABLE_W1TS_S</span><span class=w> </span><span class=err>+</span><span class=w> </span><span class=no>gpio</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
<span class=nf>sleep</span><span class=w> </span><span class=mi>0</span>
<span class=nf>jump</span><span class=w> </span><span class=no>exit</span>

<span class=nl>off:</span>
<span class=c1># turn off led (clear GPIO)</span>
<span class=nf>WRITE_RTC_REG</span><span class=p>(</span><span class=no>RTC_GPIO_ENABLE_W1TC_REG</span><span class=p>,</span><span class=w> </span><span class=no>RTC_GPIO_ENABLE_W1TC_S</span><span class=w> </span><span class=err>+</span><span class=w> </span><span class=no>gpio</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
<span class=nf>sleep</span><span class=w> </span><span class=mi>1</span>
<span class=nf>jump</span><span class=w> </span><span class=no>exit</span>
</code></pre></div></li> </ol> <p>The console output should look something like that: </p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=c1>#You can paste the following snippet into Tasmotas Berry console:</span>
<span class=w>    </span><span class=kr>import</span><span class=w> </span><span class=n>ULP</span>
<span class=w>    </span><span class=n>ULP</span><span class=p>.</span><span class=nf>wake_period</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>500000</span><span class=p>)</span><span class=w> </span><span class=c1># on time</span>
<span class=w>    </span><span class=n>ULP</span><span class=p>.</span><span class=nf>wake_period</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>200000</span><span class=p>)</span><span class=w> </span><span class=c1># off time </span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>bytes</span><span class=p>().</span><span class=nf>fromb64</span><span class=p>(</span><span class=s2>&quot;dWxwAAwAaAAAAAAADAAAgAAAAAAAAAAAEACAcgEAANDlryxyMABAgCcFzBkABWgdEACAcuGvjHIBAABoIQCAcgQAANASAIByCAAgcAQAAGgBAAWCWAAAgAQFaB0AAACSZAAAgAUFaB0BAACSZAAAgAAAALA=&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=n>ULP</span><span class=p>.</span><span class=nf>load</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
<span class=w>    </span><span class=n>ULP</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</code></pre></div> <p>After executing it the built in LED should blink (if wired to the usual GPIO 2). You can change the wake intervals on-the-fly with i.e. <code>ULP.wake_period(1, 800000)</code> in the Berry console.</p> <p>Now on to something more complex with wake from deep sleep.</p> <h3 id=hall-sensor-fsm>Hall sensor - FSM<a class=headerlink href=#hall-sensor-fsm title="Permanent link">~</a></h3> <p>We have a working example here: <a href=https://github.com/duff2013/ulptool/blob/master/src/ulp_examples/ulp_hall_sensor/hall_sensor.s>https://github.com/duff2013/ulptool/blob/master/src/ulp_examples/ulp_hall_sensor/hall_sensor.s</a></p> <p>Converting is possible in the same manner as before. Start with <code>ulp_template.py</code>, replace the string with the content of the .s file and make sure you have the include database properly populated or you add the missing defines from the header files manually.<br> Additionally we need to setup the ADC pins with the help of <code>ULP.adc_config()</code>. In this particular example the resulting code is (in the form of print outputs placed in the .py file): </p> <div class=highlight><pre><span></span><code><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ULP.adc_config(0,2,3)&quot;</span><span class=p>)</span><span class=w> </span><span class=c1># adc1_config_channel_atten(ADC1_CHANNEL_0, ADC_ATTEN_DB_6);</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ULP.adc_config(3,2,3)&quot;</span><span class=p>)</span><span class=w> </span><span class=c1># adc1_config_channel_atten(ADC1_CHANNEL_3, ADC_ATTEN_DB_6); + adc1_config_width(ADC_WIDTH_BIT_12);</span>
</code></pre></div> <p>The entry point is already at address zero, so there are no changes needed to assemble, load and start he ULP program in Tasmota. In the console output we can find the positions of the variables which hold the voltage measurements and can read out it values:</p> <div class=highlight><pre><span></span><code>0000 entry
0051 jmp_threshold
0052 exit
0053 wake_up
0059 Sens_Vp0
0060 Sens_Vn0
0061 Sens_Vp1
0062 Sens_Vn1
0063 Sens_Diff_p1
0064 Sens_Diff_n1
</code></pre></div> <p>In order to use this whole construction to wake the ESP32 with the help of a magnet, we now have to do some measurements to find feasible threshold values. This can be done by calculating the difference between <code>Sens_Vpx</code> and <code>Sens_Vnx</code> in Berry. Then place the magnet of your choice near the ESP32 and note how these values change. If the magnet is strong enough, chances are great, that you find a stable threshold.<br> Now let's add some assembly code! </p> <p>We can add some constants in the header part of the code (that worked with a tested weak magnet): <div class=highlight><pre><span></span><code><span class=w>    </span><span class=na>.set</span><span class=w> </span><span class=no>threshold_pos</span><span class=w>   </span><span class=p>,</span><span class=w> </span><span class=mi>7</span>
<span class=w>    </span><span class=na>.set</span><span class=w> </span><span class=no>threshold_neg</span><span class=w>   </span><span class=p>,</span><span class=w> </span><span class=mi>2</span>
</code></pre></div></p> <p>Now append some variables to the end of the .bss section:<br> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=na>.global</span><span class=w> </span><span class=no>Sens_Diff_p1</span>
<span class=nl>Sens_Diff_p1:</span>
<span class=w>  </span><span class=na>.long</span><span class=w> </span><span class=mi>0</span>

<span class=w>  </span><span class=na>.global</span><span class=w> </span><span class=no>Sens_Diff_n1</span>
<span class=nl>Sens_Diff_n1:</span>
<span class=w>  </span><span class=na>.long</span><span class=w> </span><span class=mi>0</span>
</code></pre></div></p> <p>The we need some code, which replaces line 135 and 136 of the original example:<br> <div class=highlight><pre><span></span><code><span class=cm>/* calculate differences */</span>
<span class=w>    </span><span class=nf>move</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>Sens_Vn1</span>
<span class=w>    </span><span class=nf>ld</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=nf>move</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>Sens_Vn0</span>
<span class=w>    </span><span class=nf>ld</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=nf>sub</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>r3</span><span class=w>         </span><span class=c1># eventually change to sub r3, r3, r2 for your setup</span>
<span class=w>    </span><span class=nf>move</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>Sens_Diff_n1</span>
<span class=w>    </span><span class=nf>st</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=no>r2</span><span class=p>,</span><span class=mi>0</span>
<span class=w>    </span><span class=nf>move</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>Sens_Vp1</span>
<span class=w>    </span><span class=nf>ld</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=nf>move</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>Sens_Vp0</span>
<span class=w>    </span><span class=nf>ld</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=nf>sub</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=w> </span><span class=no>r2</span><span class=w>          </span><span class=c1># eventually change to sub r3, r2, r3 for your setup</span>
<span class=w>    </span><span class=nf>move</span><span class=w> </span><span class=no>r2</span><span class=p>,</span><span class=w> </span><span class=no>Sens_Diff_p1</span>
<span class=w>    </span><span class=nf>st</span><span class=w> </span><span class=no>r3</span><span class=p>,</span><span class=no>r2</span><span class=p>,</span><span class=mi>0</span>

<span class=cm>/* wake up */</span>
<span class=w>    </span><span class=nf>ld</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=no>r2</span><span class=p>,</span><span class=mi>0</span><span class=w> </span><span class=c1># Sens_Diff_p1</span>
<span class=w>    </span><span class=nf>JUMPR</span><span class=w> </span><span class=no>wake_up</span><span class=p>,</span><span class=w> </span><span class=no>threshold_pos</span><span class=p>,</span><span class=w> </span><span class=no>GE</span>
</code></pre></div></p> <p>After loading and starting you can send the ESP to deep sleep. For testing it is recommended to add the optional wake timer as a fallback:<br> <code>ULP.sleep(30)</code> </p> <p>Try to wake up the system with the magnet. </p> <p>But is there a way to circumvent the limitation of this example, that forces us to set the threshold value as a constant? Well ... yes, we can do some hacky stuff. </p> <p>We must dig a little deeper, to understand how the 32-bit instructions are constructed. Let's look at the <code>jumpr</code> command, which is defined in ulp.h like that: </p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>imm</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>16</span><span class=p>;</span><span class=w>          </span><span class=cm>/*!&lt; Immediate value to compare against */</span>
<span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>cmp</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>           </span><span class=cm>/*!&lt; Comparison to perform: B_CMP_L or B_CMP_GE */</span>
<span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w>        </span><span class=cm>/*!&lt; Absolute value of target PC offset w.r.t. current PC, expressed in words */</span>
<span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>sign</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>          </span><span class=cm>/*!&lt; Sign of target PC offset: 0: positive, 1: negative */</span>
<span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>sub_opcode</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>    </span><span class=cm>/*!&lt; Sub opcode (SUB_OPCODE_B) */</span>
<span class=w>        </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>        </span><span class=cm>/*!&lt; Opcode (OPCODE_BRANCH) */</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w>                            </span><span class=cm>/*!&lt; Format of BRANCH instruction (relative address, conditional on R0) */</span>
</code></pre></div> <p>The constant (= immediate) value is stored in the upper 16 bits and we can access in the byte buffer. To find the address of the command we can simply add a label in the code: </p> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=na>.global</span><span class=w> </span><span class=no>jmp_threshold</span>
<span class=nl>jmp_threshold:</span>
<span class=w>    </span><span class=nf>JUMPR</span><span class=w> </span><span class=no>wake_up</span><span class=p>,</span><span class=w> </span><span class=no>threshold_pos</span><span class=p>,</span><span class=w> </span><span class=no>GE</span>
</code></pre></div> <p>This will get printed to the console while assembling. Then in Berry we can do a: </p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>bytes</span><span class=p>(</span><span class=s2>&quot;...&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=c1># jmp_threshold is the 32-bit-address in RTC_SLOW_MEM</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>jmp_threshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>51</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=o>+</span><span class=n>jmp_threshold</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>[</span><span class=n>pos</span><span class=o>..</span><span class=na>pos</span><span class=o>+</span><span class=mi>4</span><span class=p>]</span><span class=w>       </span><span class=c1># we do not have uint32 in Berry</span>
<span class=w>    </span><span class=n>cmd</span><span class=p>.</span><span class=nf>set</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>threshold</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w>        </span><span class=c1># upper 16 bit</span>
<span class=w>    </span><span class=n>ULP</span><span class=p>.</span><span class=nf>set_mem</span><span class=p>(</span><span class=mi>51</span><span class=p>,</span><span class=n>cmd</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>))</span><span class=w> </span><span class=c1># modify running ULP program</span>
</code></pre></div> <p>Now we can change these constant values on the fly. </p> <h4 id=example-driver-in-berry-allowing-deep-sleep-with-wake-up-via-magnet>Example driver in Berry allowing deep sleep with wake up via magnet:<a class=headerlink href=#example-driver-in-berry-allowing-deep-sleep-with-wake-up-via-magnet title="Permanent link">~</a></h4> <p>Add commands:<br> <code>hall_thres x</code> - shows current threshold for the p difference value or sets it to x.<br> <code>usleep x</code> - start deep sleep for x seconds or infinitely </p> <p><a href=https://github.com/Staars/berry-examples/blob/main/ulp_hall.be>ulp_hall.be</a></p> <h3 id=i2c-access-fsm>I2C access - FSM<a class=headerlink href=#i2c-access-fsm title="Permanent link">~</a></h3> <p>Although there are special assembler commands to access I2C devices the most common method in the examples on GitHub is bit banging. This is reported to be more reliable and circumvents some limitations (only 2 pin combinations and bytewise access with special I2C commands).<br> Nearly every example is based on some very clever macros and control flow tricks, that replicate a simple stack and subroutines (similar to a library), which is a good example for the "Art of coding".<br> To make it assemble in Micropython we need some functions in the Micropython-script, that can expand the macros. These functions are in a very early stage of development and might eventually later find their way into the micropython-esp32-ulp project after more refinement. </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If your examples do not assemble in Micropython, please try out the ESP-IDF variant.</p> </div> <p>An example for the BH-1750 light sensor can be found here: <a href=https://github.com/duff2013/ulptool/tree/master/src/ulp_examples/ulp_i2c_bitbang>https://github.com/duff2013/ulptool/tree/master/src/ulp_examples/ulp_i2c_bitbang</a></p> <p>With our techniques from above the concatenation of the .s files results in: <a href=https://github.com/Staars/berry-examples/blob/main/ulp_examples/ulp_I2C_BH1750.py>BH-1750</a> </p> <h4 id=example-berry-driver>Example Berry driver:<a class=headerlink href=#example-berry-driver title="Permanent link">~</a></h4> <p><a href=https://github.com/Staars/berry-examples/blob/main/ulp_bh1750.be>ulp_bh1750.be</a></p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8Zm114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452 0 0 1 3.53 6.716 43.765 43.765 0 0 1 .417 9.769Z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.action.edit"], "search": "../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.4b2c34cd.min.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../extra_javascript/tablesort.js></script> </body> </html>